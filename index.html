<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RTM Ligne 18 - Navigation GPS</title>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  html, body {
    height: 100%;
    font-family: sans-serif;
  }
  #map {
    position: relative;
    height: calc(100vh - 300px);
    width: 100%;
  }
  .header {
    background: #0066cc;
    color: white;
    padding: 12px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
    z-index: 1000;
  }
  .line-number {
    font-size: 24px;
    font-weight: bold;
  }
  .header-text {
    font-size: 12px;
    margin-top: 4px;
  }
  .nav-panel {
    background: white;
    padding: 16px;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    position: relative;
    z-index: 1000;
    max-width: 600px;
    margin: 0 auto;
  }
  /* ... Garde le reste de ton CSS pr√©c√©dent, comme .current-stop, .button, .gps-status ... */
</style>
</head>
<body>
  <div class="header">
    <div class="line-number">üöå Ligne 18</div>
    <div class="header-text">Castellane ‚Üí Le Bosquet</div>
  </div>
  <div id="map"></div>
  <div class="nav-panel">
    <div class="nav-info" id="navInfo" style="display:none">
      <div class="distance-info">
        <div class="distance-value" id="distanceValue">--</div>
        <div class="distance-label">m√®tres</div>
      </div>
      <div class="time-info">
        <div class="time-value" id="timeValue">--</div>
        <div class="time-label">minutes</div>
      </div>
    </div>
    <div class="instruction" id="instruction" style="display:none;">
      <div class="instruction-text" id="instructionText">Pr√©parez-vous...</div>
    </div>
    <div class="current-stop">
      <div class="label">Arr√™t actuel</div>
      <div class="stop-name" id="currentStopName">Castellane</div>
      <div class="stop-counter" id="stopCounter">Arr√™t 1 / 10</div>
    </div>
    <div class="next-stop" id="nextStopPanel">
      <div class="label">Prochain arr√™t</div>
      <div class="next-stop-name" id="nextStopName">Prado-Jean Moulin</div>
    </div>
    <div class="button-container">
      <button class="button button-secondary" id="prevBtn" disabled>‚Üê Pr√©c√©dent</button>
      <button class="button button-nav" id="startNav">üß≠ D√©marrer</button>
      <button class="button button-secondary" id="nextBtn">Suivant ‚Üí</button>
      <button class="button button-nav" id="finalNav">üö© Arr√™t final</button>
    </div>
    <div class="gps-status" id="gpsStatus">üìç Initialisation GPS...</div>
  </div>

  <script>
    window.addEventListener('load', function () {
      if (typeof mapboxgl === 'undefined') {
        document.getElementById('gpsStatus').textContent = '‚ùå Erreur de chargement Mapbox';
        return;
      }
      mapboxgl.accessToken = 'pk.eyJ1IjoidXNyNDU2IiwiYSI6ImNtaTBtZjU5dDBqbmIybXI0cnhwbGIzZzAifQ.aTjh5SjROUDfJdVUgiRc3A';

      const STOPS = [
        { id: 1, name: "Castellane", coords: [5.3810, 43.2890] },
        { id: 2, name: "Prado-Jean Moulin", coords: [5.3880, 43.2820] },
        { id: 3, name: "Menpenti", coords: [5.3950, 43.2760] },
        { id: 4, name: "St Pierre", coords: [5.4020, 43.2700] },
        { id: 5, name: "Jean Moulin", coords: [5.4090, 43.2650] },
        { id: 6, name: "La Timone", coords: [5.4160, 43.2600] },
        { id: 7, name: "La Pomme", coords: [5.4230, 43.2550] },
        { id: 8, name: "St Loup", coords: [5.4300, 43.2500] },
        { id: 9, name: "St Tronc", coords: [5.4370, 43.2450] },
        { id: 10, name: "Le Bosquet", coords: [5.4440, 43.2400] }
      ];

      let currentIdx = 0;
      let userPos = null;
      let map = null;
      let navigationActive = false;
      let routeData = null;
      let userMarker = null;
      let watchId = null;
      let autoFinalDest = false;

      try {
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [5.4090, 43.2650],
          zoom: 13
        });
      } catch (e) {
        document.getElementById('gpsStatus').textContent = '‚ùå Erreur carte: ' + e.message;
        return;
      }

      map.on('load', function () {
        STOPS.forEach(function (stop, idx) {
          const el = document.createElement('div');
          el.style.width = '30px';
          el.style.height = '30px';
          el.style.borderRadius = '50%';
          el.style.backgroundColor = idx === currentIdx ? '#FF0000' : '#0066CC';
          el.style.border = '3px solid white';
          el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
          new mapboxgl.Marker(el).setLngLat(stop.coords).addTo(map);
        });

        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            function (pos) {
              userPos = [pos.coords.longitude, pos.coords.latitude];
              if (!userMarker) {
                const el = document.createElement('div');
                el.style.width = '20px';
                el.style.height = '20px';
                el.style.borderRadius = '50%';
                el.style.backgroundColor = '#00CC00';
                el.style.border = '3px solid white';
                el.style.boxShadow = '0 0 10px rgba(0,200,0,0.5)';
                userMarker = new mapboxgl.Marker(el).setLngLat(userPos).addTo(map);
              } else {
                userMarker.setLngLat(userPos);
              }
              document.getElementById('gpsStatus').innerHTML = '<span class="gps-active">‚úì GPS actif</span>';
              if (navigationActive) {
                updateNavigation();
              }
            },
            function (err) {
              document.getElementById('gpsStatus').textContent = '‚ö†Ô∏è Activez la localisation';
            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
          );
        }
      });

      async function getRoute(start, end) {
        const url = 'https://api.mapbox.com/directions/v5/mapbox/driving/' + start[0] + ',' + start[1] + ';' + end[0] + ',' + end[1] + '?geometries=geojson&access_token=' + mapboxgl.accessToken + '&steps=true';
        const res = await fetch(url);
        const data = await res.json();
        return data.routes[0];
      }

      async function startNavigation(final = false) {
        if (!userPos) {
          alert('‚ö†Ô∏è Position GPS non disponible');
          return;
        }
        navigationActive = true;
        autoFinalDest = final;
        document.getElementById('startNav').textContent = '‚èπÔ∏è Arr√™ter';
        document.getElementById('startNav').className = 'button button-stop';
        document.getElementById('navInfo').style.display = 'flex';
        document.getElementById('instruction').style.display = 'block';
        let targetStop = final ? STOPS[STOPS.length - 1] : STOPS[currentIdx < STOPS.length - 1 ? currentIdx + 1 : currentIdx];
        routeData = await getRoute(userPos, targetStop.coords);
        if (map.getSource('route')) {
          map.getSource('route').setData({
            type: 'Feature',
            properties: {},
            geometry: routeData.geometry
          });
        } else {
          map.addSource('route', {
            type: 'geojson',
            data: {
              type: 'Feature',
              properties: {},
              geometry: routeData.geometry
            }
          });
          map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#0066CC', 'line-width': 6 }
          });
        }
        updateNavigation();
      }

      function stopNavigation() {
        navigationActive = false;
        document.getElementById('startNav').textContent = 'üß≠ D√©marrer';
        document.getElementById('startNav').className = 'button button-nav';
        document.getElementById('navInfo').style.display = 'none';
        document.getElementById('instruction').style.display = 'none';
        if (map.getLayer('route')) map.removeLayer('route');
        if (map.getSource('route')) map.removeSource('route');
        autoFinalDest = false;
      }

      async function updateNavigation() {
        if (!routeData || !userPos) return;
        routeData = await getRoute(userPos, autoFinalDest ? STOPS[STOPS.length - 1].coords : STOPS[currentIdx < STOPS.length - 1 ? currentIdx + 1 : currentIdx].coords);
        const dist = Math.round(routeData.distance);
        const time = Math.round(routeData.duration / 60);
        document.getElementById('distanceValue').textContent = dist > 999 ? Math.round(dist / 1000) + 'km' : dist;
        document.getElementById('timeValue').textContent = time;
        if (routeData.legs && routeData.legs[0].steps.length > 0) {
          const step = routeData.legs[0].steps[0];
          document.getElementById('instructionText').textContent = step.maneuver.instruction || 'Continuez tout droit';
        }
        if (dist < 30) {
          if (autoFinalDest) {
            stopNavigation();
            alert('üéâ Arriv√©e au terminus Le Bosquet !');
          } else if (currentIdx < STOPS.length - 1) {
            currentIdx++;
            updateUI();
            setTimeout(() => startNavigation(), 1000);
          } else {
            stopNavigation();
            alert('üéâ Arriv√©e au terminus Le Bosquet !');
          }
        }
      }

      function updateUI() {
        const current = STOPS[currentIdx];
        const next = currentIdx < STOPS.length - 1 ? STOPS[currentIdx + 1] : null;
        document.getElementById('currentStopName').textContent = current.name;
        document.getElementById('stopCounter').textContent = 'Arr√™t ' + (currentIdx + 1) + ' / ' + STOPS.length;
        if (next) {
          document.getElementById('nextStopPanel').style.display = 'block';
          document.getElementById('nextStopName').textContent = next.name;
        } else {
          document.getElementById('nextStopPanel').style.display = 'none';
        }
        document.getElementById('prevBtn').disabled = currentIdx === 0;
        document.getElementById('nextBtn').disabled = currentIdx === STOPS.length - 1;
      }

      document.getElementById('startNav').addEventListener('click', function () {
        if (navigationActive) {
          stopNavigation();
        } else {
          startNavigation();
        }
      });

      document.getElementById('finalNav').addEventListener('click', function () {
        startNavigation(true);
      });

      document.getElementById('nextBtn').addEventListener('click', function () {
        if (currentIdx < STOPS.length - 1) {
          currentIdx++;
          updateUI();
          if (navigationActive) startNavigation();
        }
      });

      document.getElementById('prevBtn').addEventListener('click', function () {
        if (currentIdx > 0) {
          currentIdx--;
          updateUI();
          if (navigationActive) startNavigation();
        }
      });

      updateUI();

      setInterval(function () {
        if (navigationActive && userPos) updateNavigation();
      }, 2000);
    });
  </script>
</body>
</html>
